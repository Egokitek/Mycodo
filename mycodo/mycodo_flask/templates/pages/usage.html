{% extends "layout.html" %}
{% set active_page = "usage" %}
{% set help_page = ["energy-usage", _('Energy Usage')] %}

{% block title %} - {{_('Energy Usage')}}{% endblock %}

{% block head %}
<script type="text/javascript" src="/static/js/moment.min.js"></script>
<script type="text/javascript" src="/static/js/daterangepicker.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/daterangepicker.css" />
{% endblock %}

{% block body %}

<!-- Route: /usage -->
<div class="container">
  {% include 'flash_messages.html' %}

  <h4>{{_('Energy Usage')}} <a href="/help#{{help_page[0]}}" target="_blank"><span style="font-size: 16px" class="fas fa-question-circle"></span></a></h4>

  <div style="clear: both; padding: 0.5em 0;"></div>

  <form method="post" action="/usage">
    {{form_energy_usage_add.csrf_token}}

    <div class="row align-items-end small-gutters">
      <div class="col-auto">
        {{form_energy_usage_add.energy_usage_select.label(class_='control-label')}}
        <div>
          <select class="form-control" id="energy_usage_select" name="energy_usage_select" style="width: 100%;" title="" data-original-title="{{_('Select a measurement with the unit:') + ' ' +_('Amps')}}">
            <option value="">{{dict_translation['select_one']['title']}}</option>
          {% for each_choice, value in choices_input.items() -%}
            <option value="{{each_choice}}">{{value}}</option>
          {% endfor -%}
          {% for each_choice, value in choices_math.items() -%}
            <option value="{{each_choice}}">{{value}}</option>
          {% endfor -%}
          </select>
        </div>
      </div>
      <div class="col-auto small-gutters">
        {{form_energy_usage_add.energy_usage_add(class_='form-control btn btn-sm')}}
      </div>
    </div>

  </form>

  {% if energy_usage %}
  <div style="clear: both; padding: 1em 0;"></div>
  {% endif %}

  {% for each_energy in energy_usage %}

  <div class="container" style="border: 2px solid #ddd; border-radius: 5px;">

    <form method="post" action="/usage">
    {{form_energy_usage_mod.csrf_token}}
    {{form_energy_usage_mod.energy_usage_id(value=each_energy.unique_id)}}

    <div class="row small-gutters" style="border-bottom: 1px solid #ddd; padding: 0.3em 0.2em 0.3em 0">
      <div class="col-2 col-sm-1 text-center icon-fh">
        <a data-toggle="collapse" href="#collapseContainer-input-{{each_energy.id}}" aria-expanded="false" aria-controls="collapseContainer{{each_energy.id}}">
          <span style="font-size: 3.6em" class="collapse-button{{each_energy.id}} fa fa-plus-square"></span>
        </a>
      </div>
      <div class="col-5 col-sm-3">
        {{form_energy_usage_mod.name(class_='form-control', value=each_energy.name, **{'title': dict_translation['name']['phrase']})}}
      </div>
    </div>

    <div class="row small-gutters" style="border-bottom: 1px solid #ddd">
      <div class="table-responsive">
        <table class="table">
          <tr>
            <td></td>
            <td>{{_('Past Hour')}}</td>
            <td>{{_('Past Day')}}</td>
            <td>{{_('Past Week')}}</td>
            <td>{{_('Past Month')}}</td>
          </tr>
          <tr>
            <td>{{_('Amps (Average over period)')}}</td>
            <td>{{energy_usage_stats[each_energy.unique_id]['hour']|round(3)}}</td>
            <td>{{energy_usage_stats[each_energy.unique_id]['day']|round(3)}}</td>
            <td>{{energy_usage_stats[each_energy.unique_id]['week']|round(3)}}</td>
            <td>{{energy_usage_stats[each_energy.unique_id]['month']|round(3)}}</td>
          </tr>
          <tr>
            <td>{{_('Energy Usage')}} (kWh, @{{misc.output_usage_volts}}V)</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['hour'] / 1000 / 1)|round(3)}}</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['day'] / 1000 / 24)|round(3)}}</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['week'] / 1000 / 168)|round(3)}}</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['month'] / 1000 / 720)|round(3)}}</td>
          </tr>
          <tr>
            <td>{{_('Cost')}} ({{misc.output_usage_currency}}, at {{misc.output_usage_currency}}{{misc.output_usage_cost}}/kWh)</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['hour'] / 1000 / 1 * misc.output_usage_cost)|round(2)}}</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['day'] / 1000 / 24 * misc.output_usage_cost)|round(2)}}</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['week'] / 1000 / 168 * misc.output_usage_cost)|round(2)}}</td>
            <td>{{(misc.output_usage_volts * energy_usage_stats[each_energy.unique_id]['month'] / 1000 / 720 * misc.output_usage_cost)|round(2)}}</td>
          </tr>
        </table>
      </div>
    </div>

    <div class="row align-items-end small-gutters" style="border-bottom: 1px solid #ddd; padding: 0.5em">
      <div class="col-12 col-sm-7 col-lg-4">
        {{form_energy_usage_mod.energy_usage_date_range.label(class_='control-label')}}
        <div>
          <input class="form-control" type="text" name="energy_usage_date_range" value="{{picker_start}} - {{picker_end}}" />
        </div>
      </div>
      <div class="col-auto small-gutters">
        {{form_energy_usage_mod.energy_usage_range_calc(class_='form-control btn btn-sm btn-block')}}
      </div>
      {% if calculate_usage[each_energy.unique_id] %}
      <div class="col-12 small-gutters" style="padding-top: 0.5em">
        <div class="table-responsive">
          <table class="table">
            <tr>
              <td>{{picker_start}} - {{picker_end}}</td>
              <td></td>
            </tr>
            <tr>
              <td>{{_('Amps (Average over period)')}}</td>
              <td>{{calculate_usage[each_energy.unique_id]['average_amps']|round(3)}}</td>
            </tr>
            <tr>
              <td>{{_('Energy Usage')}} (kWh, @{{misc.output_usage_volts}}V)</td>
              <td>{{calculate_usage[each_energy.unique_id]['kwh']|round(3)}}</td>
            </tr>
            <tr>
              <td>{{_('Cost')}} ({{misc.output_usage_currency}}, at {{misc.output_usage_currency}}{{misc.output_usage_cost}}/kWh)</td>
              <td>{{(calculate_usage[each_energy.unique_id]['kwh'] * misc.output_usage_cost)|round(2)}}</td>
            </tr>
          </table>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="collapse" id="collapseContainer-input-{{each_energy.id}}">
      <div class="row small-gutters" style="padding: 0.5em">
        <div class="col-auto small-gutters">
          {{form_energy_usage_mod.energy_usage_mod(class_='form-control btn btn-sm btn-block')}}
        </div>
        <div class="col-auto small-gutters">
          {{form_energy_usage_mod.energy_usage_delete(class_='form-control btn btn-sm btn-block',**{'onclick':'return confirm("Are you sure you want to delete this?")'})}}
        </div>
      </div>

      <div class="row small-gutters" style="padding: 0.5em">
        <div class="col-auto">
          {{form_energy_usage_mod.selection_device_measure_ids.label(class_='control-label')}}
          <div>
            <select class="form-control" id="selection_device_measure_ids" name="selection_device_measure_ids" style="width: 100%;" title="" data-original-title="{{_('Select a measurement with the unit:') + ' ' +_('Amps')}}">
              <option value="">None Selected</option>
            {% for each_choice, value in choices_input.items() -%}
              <option value="{{each_choice}}"{% if each_choice == each_energy.device_id + ',' + each_energy.measurement_id %} selected{% endif %}>{{value}}</option>
            {% endfor -%}
            {% for each_choice, value in choices_math.items() -%}
              <option value="{{each_choice}}"{% if each_choice == each_energy.device_id + ',' + each_energy.measurement_id %} selected{% endif %}>{{value}}</option>
            {% endfor -%}
            </select>
          </div>
        </div>
      </div>

    </div>

    </form>

  </div>

  <div style="clear: both; padding-bottom: 0.5em;"></div>

  {% endfor %}

  <div style="clear: both; padding: 1em 0;"></div>

  Energy usage calculated from output duration. Generated: {{timestamp}}

  <div style="clear: both; padding: 0.5em 0;"></div>

  <div class="table-responsive">
    <table class="table">
      <tr>
        <td>{{_('ID')}}</td>
        <td>{{_('Name')}}</td>
        <td></td>
        <td>{{_('Past Day')}}</td>
        <td>{{_('Past Week')}}</td>
        <td>{{_('Past Month')}}</td>
        <td>{{_('Past Month')}}<br/>({{_('From')}} {{misc.output_usage_dayofmonth}}{{date_suffix}})</td>
        <td>{{_('Past Year')}}</td>
      </tr>
      {% if display_order -%}
        {%- for order in display_order -%}
          {%- for each_output in output if each_output.unique_id == order and each_output.output_type not in ['pwm', 'command_pwm'] -%}
            {% for key, value in output_stats.items() if key == each_output.unique_id -%}
              <tr>
                <td>{{each_output.id}}</td>
                <td>{{each_output.name}}</td>
                <td>{{_('Duration On (hours)')}}</td>
                <td>{{value['1d']['hours_on']|round(2)}}</td>
                <td>{{value['1w']['hours_on']|round(2)}}</td>
                <td>{{value['1m']['hours_on']|round(2)}}</td>
                <td>{{value['1m_date']['hours_on']|round(2)}}</td>
                <td>{{value['1y']['hours_on']|round(2)}}</td>
              </tr>
              <tr>
                <td colspan="2"></td>
                <td>{{_('Energy Usage')}} (kWh, @{{misc.output_usage_volts}}V)</td>
                <td>{{value['1d']['kwh']|round(3)}}</td>
                <td>{{value['1w']['kwh']|round(3)}}</td>
                <td>{{value['1m']['kwh']|round(3)}}</td>
                <td>{{value['1m_date']['kwh']|round(3)}}</td>
                <td>{{value['1y']['kwh']|round(3)}}</td>
              </tr>
              <tr>
                <td colspan="2"></td>
                <td>Cost ({{misc.output_usage_currency}}, {{misc.output_usage_cost}}/kWh)</td>
                <td>{{value['1d']['cost']|round(2)}}</td>
                <td>{{value['1w']['cost']|round(2)}}</td>
                <td>{{value['1m']['cost']|round(2)}}</td>
                <td>{{value['1m_date']['cost']|round(2)}}</td>
                <td>{{value['1y']['cost']|round(2)}}</td>
              </tr>
              <tr>
                <td colspan="8"></td>
              </tr>
            {%- endfor -%}
          {%- endfor -%}
        {% endfor %}
      {%- endif -%}
      <tr>
        <td colspan="2">{{_('Total')}}</td>
        <td>{{_('Duration On (hours)')}}</td>
        <td>{{output_stats['total_duration']['1d']|round(2)}}</td>
        <td>{{output_stats['total_duration']['1w']|round(2)}}</td>
        <td>{{output_stats['total_duration']['1m']|round(2)}}</td>
        <td>{{output_stats['total_duration']['1m_date']|round(2)}}</td>
        <td>{{output_stats['total_duration']['1y']|round(2)}}</td>
      </tr>
      <tr>
        <td colspan="2"></td>
        <td>{{_('Energy Usage')}} (kWh, @{{misc.output_usage_volts}}V)</td>
        <td>{{output_stats['total_kwh']['1d']|round(3)}}</td>
        <td>{{output_stats['total_kwh']['1w']|round(3)}}</td>
        <td>{{output_stats['total_kwh']['1m']|round(3)}}</td>
        <td>{{output_stats['total_kwh']['1m_date']|round(3)}}</td>
        <td>{{output_stats['total_kwh']['1y']|round(3)}}</td>
      </tr>
      <tr>
        <td colspan="2"></td>
        <td>{{_('Cost')}} ({{misc.output_usage_currency}}, at {{misc.output_usage_currency}}{{misc.output_usage_cost}}/kWh)</td>
        <td>{{output_stats['total_cost']['1d']|round(2)}}</td>
        <td>{{output_stats['total_cost']['1w']|round(2)}}</td>
        <td>{{output_stats['total_cost']['1m']|round(2)}}</td>
        <td>{{output_stats['total_cost']['1m_date']|round(2)}}</td>
        <td>{{output_stats['total_cost']['1y']|round(2)}}</td>
      </tr>
    </table>
  </div>

  <div style="clear: both; padding: 1em 0;"></div>

</div>

<script type="text/javascript">
$(function() {
  $('input[name="energy_usage_date_range"]').daterangepicker({
    timePicker: true,
    timePicker24Hour: true,
    timePickerIncrement: 1,
    locale: {
      format: 'MM/DD/YYYY HH:mm'
    }
  });
});

$('.collapse').on('show.bs.collapse', function(){
  $(this).parent().find(".fa-plus-square").removeClass("fa-plus-square").addClass("fa-minus-square");
}).on('hide.bs.collapse', function(){
  $(this).parent().find(".fa-minus-square").removeClass("fa-minus-square").addClass("fa-plus-square");
});
</script>

{% endblock %}
