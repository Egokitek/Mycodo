{% extends "layout.html" %}
{% set active_page = "pid" %}
{% set help_page = ["pids", _('PID Controllers')] %}

{% block title %} - {{_('PID')}}{% endblock %}

{% block head %}
  <link rel="stylesheet" type="text/css" href="/static/css/bootstrap-clockpicker.min.css">
{% endblock %}

{% block body %}
  <!-- Route: /pid -->
  <div class="container">
    {% include 'flash_messages.html' %}

    <h4>{{_('PID Controllers')}} <a href="/help#pids" target="_blank"><span style="font-size: 16px" class="glyphicon glyphicon-question-sign"></span></a></h4>

    <p>{{_('PID controllers couple an input with a device connected to an output to regulate an environmental condition. For example, this could be a heater and a temperature sensor, allowing the regulation of temperature.')}}</p>

    <div style="clear: both; padding: 0.5em 0;"></div>

    <form method="post" action="/pid">
    <div class="row small-gutters" style="padding-left: 1em">
      <input type="hidden" name="form-name" value="addPID">
      {{form_add_pid.hidden_tag()}}
      <div class="col-xs-2 col-sm-1 no-gutters">
        {{form_add_pid.numberPIDs.label(class_='control-label')}}
        <div>
          {{form_add_pid.numberPIDs(class_='form-control', value=1, type="number")}}
        </div>
      </div>
      <div class="col-xs-5 col-sm-3 col-md-2 small-gutters">
        {{form_add_pid.pid_type_input.label(class_='control-label')}}
        <div>
          <select class="form-control form-tooltip form-dropdown" id="pid_type_input" name="pid_type_input" data-placement="top" title="{{_('Where to get the input for the PID')}}">
            <option value="sensor">Sensor Input</option>
            <option value="command">Command Input</option>
          </select>
        </div>
      </div>
      <div class="col-xs-5 col-sm-3 col-md-2 small-gutters">
        {{form_add_pid.pid_type.label(class_='control-label')}}
        <div>
          <select class="form-control form-tooltip form-dropdown" id="pid_type" name="pid_type" data-placement="top" title="{{_('Where to send the output of the PID')}}">
            <option value="relay">Relay Output</option>
            <option value="pwm">PWM Output</option>
          </select>
        </div>
      </div>
    </div>
    <div class="row small-gutters" style="padding-left: 1em">
      <div class="col-xs-12 col-sm-3 col-lg-2 no-gutters">
        {{form_add_pid.pidAddSubmit(class_='form-control btn btn-default')}}
      </div>
    </div>
    </form>

    <div style="clear: both; padding: 1em 0;"></div>

    {%- if displayOrder -%}
    {%- for order in displayOrder -%}
      {%- for each_pid in pids if each_pid.id == order -%}

        <div class="container" style="margin-bottom: 0.5em; border: 2px solid #ddd; border-radius: 5px;">
          <form method="post" action="/pid">
          <input type="hidden" name="form-name" value="modPID">
          {{form_mod_pid_base.csrf_token}}
          {{form_mod_pid_base.pid_id(value=each_pid.id)}}
          <div class="{% if each_pid.is_activated and not each_pid.is_paused -%}active-background
                      {% elif each_pid.is_activated and each_pid.is_paused -%}pause-background
                      {% elif each_pid.is_held -%}hold-background
                      {% else -%}inactive-background
                      {% endif %} row small-gutters" style="border-bottom: 2px solid #ddd; padding: 0.5em;">
            <div class="col-xs-12 small-gutters">
              <div class="col-xs-6 col-md-6 no-gutters">
                {{form_mod_pid_base.name(class_='form-control', value=each_pid.name, **{'title':_('Name for this PID controller.')})}}
              </div>
              <div class="col-xs-6 no-gutters">
                <input class="form-control btn btn-default" title="UUID: {{each_pid.unique_id}}" disabled="" value="ID: {{each_pid.id}}, {{each_pid.pid_type_input}} in, {{each_pid.pid_type}} out,
                {%- if each_pid.is_activated and not each_pid.is_paused %} {{_('Active')}}
                {%- elif each_pid.is_activated and each_pid.is_paused %} {{_('Paused')}}
                {%- elif each_pid.is_held %} {{_('On Hold')}}
                {%- else %} {{_('Inactive')}}
                {%-endif -%}
                " type="text">
              </div>
            </div>
            <div class="col-xs-12 col-sm-6 small-gutters">
              {%- if each_pid.is_activated %}
                <div class="col-xs-12 col-sm-12 col-md-6 no-gutters">
                  {{form_mod_pid_base.deactivate(class_='form-control btn btn-default')}}
                </div>
                {%- if each_pid.is_paused or each_pid.is_held %}
                  <div class="col-xs-6 col-sm-6 col-md-3 no-gutters">
                    {{form_mod_pid_base.resume(class_='form-control btn btn-default')}}
                  </div>
                {%- else %}
                  <div class="col-xs-6 col-sm-6 col-md-3 no-gutters">
                    {{form_mod_pid_base.pause(class_='form-control btn btn-default')}}
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-3 no-gutters">
                    {{form_mod_pid_base.hold(class_='form-control btn btn-default')}}
                  </div>
                {%- endif -%}
              {%- else %}
                <div class="col-xs-12 no-gutters">
                  {{form_mod_pid_base.activate(class_='form-control btn btn-default')}}
                </div>
              {%- endif -%}
            </div>
            <div class="col-xs-6 col-sm-3 small-gutters">
              <div class="col-xs-6 col-sm-12 col-md-6 no-gutters">
                {{form_mod_pid_base.save(class_='form-control btn btn-default')}}
              </div>
              <div class="col-xs-6 col-sm-12 col-md-6 no-gutters">
                {{form_mod_pid_base.delete(class_='form-control btn btn-default',**{'onclick':'return confirm("Are you sure you want to delete this PID controller?")'})}}
              </div>
            </div>
            <div class="col-xs-6 col-sm-3 small-gutters">
              <div class="col-xs-6 col-sm-12 col-md-6 no-gutters">
                {{form_mod_pid_base.reorder_up(class_='form-control btn btn-default')}}
              </div>
              <div class="col-xs-6 col-sm-12 col-md-6 no-gutters">
                {{form_mod_pid_base.reorder_down(class_='form-control btn btn-default')}}
              </div>
            </div>
          </div>

        {% if each_pid.pid_type_input == 'command' %}
          {% include 'pages/pid_options/input_command.html' %}
        {% elif each_pid.pid_type_input == 'sensor' %}
          {% include 'pages/pid_options/input_sensor.html' %}
        {% endif %}

        {% include 'pages/pid_options/options_pid.html' %}

        {% if each_pid.pid_type == 'relay' %}
          {% include 'pages/pid_options/output_relay.html' %}
        {% elif each_pid.pid_type == 'pwm' %}
          {% include 'pages/pid_options/output_pwm.html' %}
        {% endif %}

          <div class="row small-gutters" style="padding-bottom: 0.3em">
            <div class="col-xs-12 col-sm-12">
              {{form_mod_pid_base.method_id.label(class_='control-label')}}
            </div>
            <div class="col-xs-6 col-sm-3 col-lg-2">
              <select class="form-control" id="method_id" name="method_id" title="" data-original-title="{{_('Select the method to use when calculating the setpoint. When enabled, the setpoint(s) of the method override the PID setpoint above.')}}">
                {%- if method == [] -%}
                  <option value="0">{{_('No methods exist. Create one with this button')}} -></option>
                {%- else -%}
                  <option value="0">{{_('Disabled')}}</option>
                {%- endif-%}

                {%- set valid_saved_method = [] -%}
                {%- for each_method in method -%}
                  {%- if each_method.id == each_pid.method_id -%}
                    {%- do valid_saved_method.append(1) -%}
                  {%- endif -%}
                  <option value="{{each_method.id}}"{% if each_pid.method_id == each_method.id %} selected{% endif %}>{{each_method.id}} ({{each_method.name}})</option>
                {%- endfor -%}
                {%- if not valid_saved_method and each_pid.method_id -%}
                  <option value="" selected>{{_('Invalid saved method. Save another method from this list.')}}</option>
                {%- endif -%}
              </select>
            </div>
            <div class="col-xs-6 col-sm-3 col-lg-2">
              <a href="/method" class="form-control btn btn-default" role="button">{{_('Manage Methods')}}</a>
            </div>
          </div>
        </form>

        </div>

      {%- endfor -%}

        <div style="clear: both; padding:1em 0;"></div>
    {%- endfor -%}
    {%- endif -%}

  </form>

  <script type="text/javascript" src="/static/js/bootstrap-clockpicker.min.js"></script>
  <script type="text/javascript">
    $('.clockpicker').clockpicker({
      donetext: 'Done'
    });
  </script>

{% endblock %}
