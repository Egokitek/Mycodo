{% extends "layout.html" %}
{% set active_page = "live" %}
{% set help_page = ["live-measurements", _('Live Measurements')] %}

{% block title %} - {{_('Live')}}{% endblock %}

{% block head %}
  <script>
    function updateMeasurements(unique_id, measure_type, measurement_id, period) {
      var url = '/last/' + unique_id + '/' + measure_type + '/' + measurement_id + '/' + period.toString();
      var measure_string = '';
      measure_string = unique_id + '-' + measure_type + '-' + measurement_id;
      $.ajax(url, {
        success: function(data, responseText, jqXHR) {
          if (jqXHR.status === 204) {
            document.getElementById(measure_string + "-time").innerHTML = "No Data Last " + period.toString() + " sec";
            document.getElementById(measure_string + "-value").innerHTML = "0";
          }
          else {
            var time = data[0];
            var measurement_val = parseFloat(data[1].toFixed(3));
            var date = new Date(parseFloat(time));
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            var hours = date.getHours();
            var minutes = "0" + date.getMinutes();
            var seconds = "0" + date.getSeconds();
            document.getElementById(measure_string + "-time").innerHTML = year + "/" + month + "/" + day + " " + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
            document.getElementById(measure_string + "-value").innerHTML = measurement_val;
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          document.getElementById(measure_string + "-time").innerHTML = "No Data Last " + period.toString() + " sec";
          document.getElementById(measure_string + "-value").innerHTML = "0";
        },
        cache: false
      });
    }

    function liveTextData(unique_id, measure_type, measurement_id, period) {
      // Update when page first loads
      updateMeasurements(unique_id, measure_type, measurement_id, period);
      setInterval(function () {
        // Update after every 30 seconds
        updateMeasurements(unique_id, measure_type, measurement_id, period);
      }, 30000);
    }

    $(function() {
      {%- for each_input in input if each_input.is_activated -%}
        {% for each_meas in device_measurements if each_meas.device_id == each_input.unique_id and each_meas.is_enabled %}
          liveTextData('{{each_input.unique_id}}', 'input', '{{each_meas.unique_id}}', {{each_input.period + 1}});
        {% endfor %}
      {%- endfor -%}

      {%- for each_math in math if each_math.is_activated -%}
        {% for each_meas in device_measurements if each_meas.device_id == each_math.unique_id and each_meas.is_enabled %}
          liveTextData('{{each_math.unique_id}}', 'math', '{{each_meas.unique_id}}', {{each_math.period + 1}});
        {% endfor %}
      {%- endfor -%}
    });
  </script>
{% endblock %}

{%- block body %}
  <!-- Route: /live -->
  <main role="main" class="container">

    {% include 'flash_messages.html' %}

    {%- if inputs_sorted|length == 0 and maths_sorted|length == 0 -%}
    <div>
      {{_('No Data Sources Activated')}}. <a href="/data">Click here</a> to go to the Data page. Read the <a href="/help">Manual</a> to become more familiar with the system and configuration options.
    </div>
    {%- endif -%}

    {%- for each_input_sorted in inputs_sorted -%}
      {%- set collapse_container_number = loop.index -%}

      {%- for each_input in input if each_input.unique_id == each_input_sorted -%}

    <div style="padding: 0.5em; margin-bottom: 0.7em; border: 1px solid #ddd; border-radius: 5px;">

      <div class="row">
        <div class="col-xs-12 col-sm-6 text-left">
          {{each_input.name}} (Input {{each_input.unique_id[:8]}})
          {%- if each_input.device != 'EDGE' -%}
            <div>
               {{_('Input (%(type)s), %(sec)s second interval', type=each_input.device, sec=each_input.period)}}
            </div>
          {%- endif -%}
        </div>

        <div class="col-xs-12 col-sm-6 text-right">
          {{_('Measurement')}} | {{_('Timestamp')}}
        {% for each_meas in device_measurements if each_meas.device_id == each_input.unique_id and each_meas.is_enabled %}
          {% set measure_string = each_input.unique_id + '-input-' + each_meas.unique_id %}
          <div>
            <b><span id="{{measure_string}}-value">0.0</span>

          {%- if dict_units[dict_measurements_units[each_meas.unique_id]]['unit'] -%}
            {{' ' + dict_units[dict_measurements_units[each_meas.unique_id]]['unit']}}
          {%- endif -%}</b>

          {%- if each_meas.conversion_id or each_meas.rescaled_unit -%}
            {{' (' + dict_units[dict_measurements_units[each_meas.unique_id]]['name'] + ') '}}
          {%- else -%}
            {{' (' + dict_measurements[each_meas.measurement]['name'] + ') '}}
          {%- endif -%}

          {%- if each_meas.name -%}
            {{' (' + each_meas.name + ') '}}
          {%- endif -%}

            CH{{each_meas.channel + 1}} | <span id="{{measure_string}}-time">&lt;{{_('Please wait')}}&gt;</span><br>
          </div>
        {% endfor %}
        </div>
      </div>

    </div>

      {%- endfor -%}
    {%- endfor -%}


    {%- for each_math_sorted in maths_sorted -%}
      {%- set collapse_container_number = loop.index -%}

      {%- for each_math in math if each_math.unique_id == each_math_sorted -%}

    <div style="padding: 0.5em; margin-bottom: 0.7em; border: 1px solid #ddd; border-radius: 5px;">

      <div class="row">
        <div class="col-xs-12 col-sm-6 text-left">
          {%- set math_has_pid = [] -%}
          {%- for each_pid in pid if each_pid.is_activated and each_pid.measurement.split(',')[0] == each_math.unique_id -%}
            {%- do math_has_pid.append(1) -%}
          {%- endfor -%}
          {%- if math_has_pid -%}
            <a style="padding-right: 0.5em" data-toggle="collapse" href="#collapseContainer{{collapse_container_number}}" aria-expanded="false" aria-controls="collapseContainer{{collapse_container_number}}"><span class='collapse-button{{collapse_container_number}} fa fa-2x fa-plus-square'></span></a>
          {%- endif -%}
          {{each_math.name}} (Math {{each_math.unique_id[:8]}})
          <div>
            {{_('Math (%(type)s), %(sec)s second interval', type=each_math.math_type, sec=each_math.period)}}
          </div>
        </div>

        <div class="col-xs-12 col-sm-6 text-right">
          {{_('Measurement')}} | {{_('Timestamp')}}
        {% for each_meas in device_measurements if each_meas.device_id == each_math.unique_id and each_meas.is_enabled %}
          {% set measure_string = each_math.unique_id + '-math-' + each_meas.unique_id %}
          <div>
            <b><span id="{{measure_string}}-value">0.0</span>

          {%- if dict_units[dict_measurements_units[each_meas.unique_id]]['unit'] -%}
            {{' ' + dict_units[dict_measurements_units[each_meas.unique_id]]['unit']}}
          {%- endif -%}</b>

          {%- if not each_meas.conversion_id -%}
            {{' (' + dict_measurements[each_meas.measurement]['name'] + ') '}}
          {%- else -%}
            {{' (' + dict_units[dict_measurements_units[each_meas.unique_id]]['name'] + ') '}}
          {%- endif -%}

          {%- if each_meas.name -%}
            {{' (' + each_meas.name + ') '}}
          {%- endif -%}

            CH{{each_meas.channel + 1}} | <span id="{{measure_string}}-time">&lt;{{_('Please wait')}}&gt;</span><br>
          </div>
        {% endfor %}
        </div>

      </div>

    </div>

      {%- endfor -%}
    {%- endfor -%}

  </main>

  <script>
    $('.collapse').on('show.bs.collapse', function(){
      $(this).parent().find(".fa-plus-square").removeClass("fa-plus-square").addClass("fa-minus-square");
    }).on('hide.bs.collapse', function(){
      $(this).parent().find(".fa-minus-square").removeClass("fa-minus-square").addClass("fa-plus-square");
    });
  </script>

{% endblock -%}
