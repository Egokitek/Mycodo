{% extends "layout.html" %}
{% set active_page = "sensor" %}

{% block title %} - Sensors{% endblock %}

{% block head %}
  <script>
    $(document).ready(function(){
      $('input[title]').tooltip({placement:'bottom'});
    })
  </script>
{% endblock %}

{%- block body %}

  <div class="container">
    {% include 'flash_messages.html' %}

    <form class="form-inline" method="post" action="/sensor">
      <input type="hidden" name="form-name" value="addSensor">
      {{formAddSensor.hidden_tag()}}
      <div class="form-group">
        {{formAddSensor.numberSensors(class_='form-control',type="number",**{'rel':'tooltip','title':'How many sensors to add'})}}
      </div>
      <div class="form-group">
        {{formAddSensor.sensor(class_='form-control')}}
      </div>
      <div class="form-group">
        {{formAddSensor.sensorAddSubmit(class_='form-control btn btn-default')}}
      </div>
    </form>

    <div style="clear: both; padding:1em 0;"></div>

    {%- if displayOrder -%}
    {%- for order in displayOrder -%}
      {%- for each_sensor in sensor if each_sensor.id in order -%}

        <div class="table-responsive" style="border: 2px solid #ddd; border-radius: 5px;">
          <table class="table {% if each_sensor.activated -%}active-background{%- else -%}inactive-background{% endif -%}">
            <tr>
              <th rowspan="2" class="col-sm-2">
                <form method="post" action="/sensor">
                  {%- if each_sensor.activated %}

                    {%- set has_active_pid = [] -%}
                    {%- for each_pid in pid if each_pid.sensor_id == each_sensor.id and each_pid.activated -%}
                      {%- do has_active_pid.append(1) -%}
                    {%- endfor -%}

                    {%- set has_active_lcd = [] -%}
                    {%- for each_lcd in lcd if each_lcd.activated and (each_lcd.line_1_sensor_id == each_sensor.id or each_lcd.line_2_sensor_id == each_sensor.id or each_lcd.line_3_sensor_id == each_sensor.id or each_lcd.line_4_sensor_id == each_sensor.id) -%}
                      {%- do has_active_lcd.append(1) -%}
                    {%- endfor -%}

                    <input type="hidden" name="form-name" value="deactivateSensor">
                    {{formDeactivateSensor.csrf_token}}
                    {{formDeactivateSensor.deactivateSensor_id(value=each_sensor.id)}}
                    {%- if has_active_pid or has_active_lcd -%}
                      {{formDeactivateSensor.deactivateSensorSubmit(class_='form-control btn btn-default',**{'onclick':'return confirm("There are currently active PID or LCD controllers that rely on this sensor to be active. If you deactivate this sensor, all active PID and LCD controllers that use it will be deactivated. Select OK to deactivate this sensor and all associated PID and LCD controllers, otherwise click Cancel to leave them active.")'})}}
                    {%- else -%}
                      {{formDeactivateSensor.deactivateSensorSubmit(class_='form-control btn btn-default')}}
                    {%- endif -%}
                  {%- else -%}
                    <input type="hidden" name="form-name" value="activateSensor">
                    {{formActivateSensor.csrf_token}}
                    {{formActivateSensor.activateSensor_id(value=each_sensor.id)}}
                    {{formActivateSensor.activateSensorSubmit(class_='form-control btn btn-default')}}
                  {%- endif %}
                </form>
                {% if each_sensor.device != 'RPiCPULoad' %}
                <form method="post" action="/sensor">
                  <input type="hidden" name="form-name" value="addSensorConditional">
                  {{formAddSensorCond.csrf_token}}
                  {{formAddSensorCond.addSensorCond_sensorid(value=each_sensor.id)}}
                  {{formAddSensorCond.sensorCondAddSubmit(class_='form-control btn btn-default')}}
                </form>
                {% endif %}
              </th>
              <th rowspan="2" class="col-sm-2">
                <form method="post" action="/sensor">
                  <input type="hidden" name="form-name" value="orderSensor">
                  {{formOrderSensor.csrf_token}}
                  {{formOrderSensor.orderSensor_id(value=each_sensor.id)}}
                  {{formOrderSensor.orderSensorUp(class_='form-control btn btn-default')}}
                  {{formOrderSensor.orderSensorDown(class_='form-control btn btn-default')}}
                </form>
              </th>
              <th rowspan="2" class="col-sm-2">
                <form method="post" action="/sensor">
                  <input type="hidden" name="form-name" value="delSensor">
                  {{formDelSensor.csrf_token}}
                  {{formDelSensor.delSensor_id(value=each_sensor.id)}}
                  {%- if has_active_pid or has_active_lcd -%}
                    {{formDelSensor.delSensorSubmit(class_='form-control btn btn-default',**{'onclick':'return confirm("Note: there are currently active PID or LCD controlelrs that rely on this sensor to operate. Deleting it will deactivate these sensors. Are you sure you want to delete this sensor?")'})}}
                  {%- else -%}
                    {{formDelSensor.delSensorSubmit(class_='form-control btn btn-default',**{'onclick':'return confirm("Are you sure you want to delete this sensor?")'})}}
                  {%- endif -%}
                </form>
                <form method="post" action="/sensor">
                  <input type="hidden" name="form-name" value="modSensor">
                  {{formModSensor.csrf_token}}
                  {{formModSensor.modSensor_id(value=each_sensor.id)}}
                  {{formModSensor.modSensorSubmit(class_='form-control btn btn-default')}}
              </th>
              <th class="col-sm-6">{{formModSensor.modName(class_='form-control', value=each_sensor.name)}}</th>
            </tr>
            <tr>
              <td>ID {{each_sensor.id}}</td>
            </tr>
          </table>

          <table class="table">
            <tr>
              <td class="col-sm-1">
                Device
              </td>
              {% if each_sensor.device in ['DHT11', 'DHT22', 'SHT', 'EDGE'] %}
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    GPIO
                  </label>
                </td>
              {% endif %}
              {% if each_sensor.device == 'EDGE' %}
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Edge
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Bounce Time (ms)
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Reset Period (sec)
                  </label>
                </td>
              {% endif %}
              {% if each_sensor.device == 'DS18B20' %}
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Device ID (28-x)
                  </label>
                </td>
              {% endif %}
              {% if each_sensor.device in ['AM2315', 'BMP', 'TSL2561', 'TMP006'] %}
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    I2C Address
                  </label>
                </td>
              {% endif %}
              {% if each_sensor.device == 'K30' %}
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Interface
                  </label>
                </td>
              {% endif %}
              {% if each_sensor.device in ['AM2315', 'BMP', 'TSL2561', 'TMP006', 'MCP342x'] %}
                <td class="col-sm-1">
                  <label class="control-label" for="modMultiplexAddress">
                    Multiplexer<br>I<sup>2</sup>C Address
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modMultiplexChannel">
                    Multiplexer<br>Channel
                  </label>
                </td>
              {% endif %}
              {% if each_sensor.device not in ['EDGE'] %}
                <td class="col-sm-1">{{formModSensor.modPeriod.label(class_='control-label')}}</td>
                {% if each_sensor.device != 'RPiCPULoad' %}
                  <td class="col-sm-2">{{formModSensor.modPreRelayID.label(class_='control-label')}}</td>
                  <td class="col-sm-1">{{formModSensor.modPreRelayDuration.label(class_='control-label')}}</td>
                  {% if each_sensor.device == 'SHT' %}
                    <td class="col-sm-1">{{formModSensor.modSHTClockPin.label(class_='control-label')}}</td>
                    <td class="col-sm-1">{{formModSensor.modSHTVoltage.label(class_='control-label')}}</td>
                  {% endif %}
                {% endif %}
              {% endif %}
            </tr>
            <tr>
              <td>
                <input class="form-control" disabled="" value="{{each_sensor.device}}" type="text">
              </td>
              {% if each_sensor.device in ['DS18B20', 'DHT11', 'DHT22', 'SHT', 'EDGE', 'TSL2561', 'TMP006'] %}
                <td>
                  {{formModSensor.modLocation(class_='form-control', value=each_sensor.location)}}
                </td>
              {% elif each_sensor.device in ['AM2315', 'BMP', 'K30'] %}
                <td>
                  {{formModSensor.modLocation(class_='form-control', value=each_sensor.location, disabled=True)}}
                  <input type="hidden" class="form-control" id="modLocation" name="modLocation" value="{{each_sensor.location}}">
                </td>
              {% endif %}
              {% if each_sensor.device in ['AM2315', 'BMP', 'TSL2561', 'TMP006', 'MCP342x'] %}
                <td>
                  <select class="form-control" id="modMultiplexAddress" name="modMultiplexAddress">
                    <option value=""{% if each_sensor.multiplexer_address == '' %} selected{% endif %}></option>
                    <option value="0x70"{% if each_sensor.multiplexer_address == '0x70' %} selected{% endif %}>0x70</option>
                    <option value="0x71"{% if each_sensor.multiplexer_address == '0x71' %} selected{% endif %}>0x71</option>
                    <option value="0x72"{% if each_sensor.multiplexer_address == '0x72' %} selected{% endif %}>0x72</option>
                    <option value="0x73"{% if each_sensor.multiplexer_address == '0x73' %} selected{% endif %}>0x73</option>
                    <option value="0x74"{% if each_sensor.multiplexer_address == '0x74' %} selected{% endif %}>0x74</option>
                    <option value="0x75"{% if each_sensor.multiplexer_address == '0x75' %} selected{% endif %}>0x75</option>
                    <option value="0x76"{% if each_sensor.multiplexer_address == '0x76' %} selected{% endif %}>0x76</option>
                    <option value="0x77"{% if each_sensor.multiplexer_address == '0x77' %} selected{% endif %}>0x77</option>
                  </select>
                </td>
                <td>
                  <select class="form-control" id="modMultiplexChannel" name="modMultiplexChannel">
                    <option value="0"{% if each_sensor.multiplexer_channel == 0 %} selected{% endif %}></option>
                    <option value="1"{% if each_sensor.multiplexer_channel == 1 %} selected{% endif %}>1</option>
                    <option value="2"{% if each_sensor.multiplexer_channel == 2 %} selected{% endif %}>2</option>
                    <option value="3"{% if each_sensor.multiplexer_channel == 3 %} selected{% endif %}>3</option>
                    <option value="4"{% if each_sensor.multiplexer_channel == 4 %} selected{% endif %}>4</option>
                    <option value="5"{% if each_sensor.multiplexer_channel == 5 %} selected{% endif %}>5</option>
                    <option value="6"{% if each_sensor.multiplexer_channel == 6 %} selected{% endif %}>6</option>
                    <option value="7"{% if each_sensor.multiplexer_channel == 7 %} selected{% endif %}>7</option>
                    <option value="8"{% if each_sensor.multiplexer_channel == 8 %} selected{% endif %}>8</option>
                  </select>
                </td>
              {% endif %}
              {% if each_sensor.device == 'EDGE' %}
                <td>
                  <select class="form-control" id="modSwitchEdge" name="modSwitchEdge">
                    <option value="rising"{% if each_sensor.switch_edge == "rising" %} selected{% endif %}>Rising</option>
                    <option value="falling"{% if each_sensor.switch_edge == "falling" %} selected{% endif %}>Falling</option>
                    <option value="both"{% if each_sensor.switch_edge == "both" %} selected{% endif %}>Both</option>
                  </select>
                <td>{{formModSensor.modSwitchBounceTime(class_='form-control', value=each_sensor.switch_bouncetime)}}</td>
                <td>{{formModSensor.modSwitchResetPeriod(class_='form-control', value=each_sensor.switch_reset_period)}}</td>
              {% endif %}
              {% if each_sensor.device not in ['EDGE'] %}
                <td>{{formModSensor.modPeriod(class_='form-control', value=each_sensor.period)}}</td>
              {% else %}
                <input id="modPeriod" name="modPeriod" type="hidden" value="10">
              {% endif %}
              {% if each_sensor.device not in ['RPiCPULoad', 'EDGE'] %}
                <td>
                  <select class="form-control" id="modPreRelayID" name="modPreRelayID">
                    <option value=""></option>
                    {%- for rel in relay -%}
                      <option value="{{rel.id}}"{% if each_sensor.pre_relay_id == rel.id %} selected{% endif %}>{{rel.id}} ({{rel.name}})</option>
                    {%- endfor -%}
                  </select>
                </td>
                <td>{{formModSensor.modPreRelayDuration(class_='form-control', value=each_sensor.pre_relay_duration)}}</td>
              {% else %}
                <input id="modPreRelayID" name="modPreRelayID" type="hidden" value="0">
                <input id="modPreRelayDuration" name="modPreRelayDuration" type="hidden" value="0">
              {% endif %}
              {% if each_sensor.device in ['SHT'] %}
                <td>{{formModSensor.modSHTClockPin(class_='form-control', value=each_sensor.sht_clock_pin)}}</td>
                <td>{{formModSensor.modSHTVoltage(class_='form-control', value=each_sensor.sht_voltage)}}</td>
              {% else %}
                <input id="modSHTClockPin" name="modSHTClockPin" type="hidden" value="0">
                <input id="modSHTVoltage" name="modSHTVoltage" type="hidden" value="0">
              {% endif %}
            </tr>
          </table>
          {% if each_sensor.device == 'MCP342x' %}
            <table class="table">
              <tr>
                <td class="col-sm-2">
                  <label class="control-label" for="modDevice">
                    Measurement
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Units
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    I2C Address
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Channel
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Resolution
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Volts Min
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Volts Max
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Units Min
                  </label>
                </td>
                <td class="col-sm-1">
                  <label class="control-label" for="modDevice">
                    Units Max
                  </label>
                </td>
              </tr>
              <tr>
                <td>
                  {{formModSensor.modADCMeasure(class_='form-control', value=each_sensor.adc_measure)}}
                </td>
                <td>
                  {{formModSensor.modADCMeasureUnits(class_='form-control', value=each_sensor.adc_measure_units)}}
                </td>
                <td>
                  <select class="form-control" id="modADCAddress" name="modADCAddress">
                    <option value=""{% if each_sensor.adc_address == '' %} selected{% endif %}></option>
                    <option value="0x68"{% if each_sensor.adc_address == '0x68' %} selected{% endif %}>0x68</option>
                    <option value="0x6A"{% if each_sensor.adc_address == '0x6A' %} selected{% endif %}>0x6A</option>
                    <option value="0x6C"{% if each_sensor.adc_address == '0x6C' %} selected{% endif %}>0x6C</option>
                    <option value="0x6E"{% if each_sensor.adc_address == '0x6E' %} selected{% endif %}>0x6E</option>
                  </select>
                </td>
                <td>
                  <select class="form-control" id="modADCChannel" name="modADCChannel">
                    <option value="0"{% if each_sensor.adc_channel == 0 %} selected{% endif %}>1</option>
                    <option value="1"{% if each_sensor.adc_channel == 1 %} selected{% endif %}>2</option>
                    <option value="2"{% if each_sensor.adc_channel == 2 %} selected{% endif %}>3</option>
                    <option value="3"{% if each_sensor.adc_channel == 3 %} selected{% endif %}>4</option>
                  </select>
                </td>
                <td>
                  {{formModSensor.modADCResolution(class_='form-control', value=each_sensor.adc_resolution)}}
                </td>
                <td>
                  {{formModSensor.modADCVoltsMin(class_='form-control', value=each_sensor.adc_volts_min)}}
                </td>
                <td>
                  {{formModSensor.modADCVoltsMax(class_='form-control', value=each_sensor.adc_volts_max)}}
                </td>
                <td>
                  {{formModSensor.modADCUnitsMin(class_='form-control', value=each_sensor.adc_units_min)}}
                </td>
                <td>
                  {{formModSensor.modADCUnitsMax(class_='form-control', value=each_sensor.adc_units_max)}}
                </td>
              </tr>
            </table>
          {% endif %}
          </form>

        {%- for each_sensorcond in sensor_conditional if each_sensorcond.sensor_id == each_sensor.id -%}
          <div class="table-responsive" style="margin: 0.5em 0.5em 0.5em 0.5em; border: 2px solid #ddd; border-radius: 5px;">
            <form method="post" action="/sensor" class="form-inline">
              <input type="hidden" name="form-name" value="modSensorConditional">
              {{formModSensorCond.csrf_token}}
              {{formModSensorCond.modCondSensor_id(value=each_sensorcond.id)}}
              {{formModSensorCond.modSensor_id(value=each_sensor.id)}}
              <table class="table {% if each_sensorcond.activated -%}active-background{%- else -%}inactive-background{% endif -%}">
                <tr>
                  <td class="col-sm-2">{{formModSensorCond.modCondName(class_='form-control', value=each_sensorcond.name)}}</td>
                  <td class="col-sm-1" style="vertical-align: bottom">{{each_sensorcond.id}}</td>
                  <td class="col-sm-5"></td>
                  <td class="col-sm-4 text-right">
                    {%- if each_sensorcond.activated %}
                      {{formModSensorCond.deactivateSubmit(class_='form-control btn btn-default')}}
                    {%- else -%}
                      {{formModSensorCond.activateSubmit(class_='form-control btn btn-default')}}
                    {%- endif %}
                    {{formModSensorCond.modSubmit(class_='form-control btn btn-default')}} {{formModSensorCond.delSubmit(class_='form-control btn btn-default',**{'onclick':'return confirm("Are you sure you want to delete this sensor conditional?")'})}}
                  </td>
                </tr>
              </table>
              
              <table class="table">
                <tr>
                  <td>If</td>
                  {% if each_sensor.device_type == 'edgedetect' %}
                    <td class="text-left">
                      Edge Detected, Direction of change: 
                      <select class="form-control" id="EdgeDetected " name="EdgeDetected">
                        <option value="rising">Rising</option>
                        <option value="falling">Falling</option>
                        <option value="both">Both</option>
                      </select>
                    </td>
                  {% else %}
                    <td class="text-left">
                      <select class="form-control" id="MeasureType" name="MeasureType">
                        <option value=""></option>
                        {%- if each_sensor.device_type == 'tsensor' -%}
                          <option value="temperature"{% if each_sensorcond.measurement_type == 'temperature' %} selected{% endif %}>Temperature</option>
                        {%- elif each_sensor.device_type == 'htsensor' -%}
                          <option value="temperature"{% if each_sensorcond.measurement_type == 'temperature' %} selected{% endif %}>Temperature</option>
                          <option value="humidity"{% if each_sensorcond.measurement_type == 'humidity' %} selected{% endif %}>Humidity</option>
                        {%- elif each_sensor.device_type == 'co2sensor' -%}
                          <option value="co2"{% if each_sensorcond.measurement_type == 'co2' %} selected{% endif %}>CO2</option>
                        {%- elif each_sensor.device_type == 'presssensor' -%}
                          <option value="temperature"{% if each_sensorcond.measurement_type == 'temperature' %} selected{% endif %}>Temperature</option>
                          <option value="pressure"{% if each_sensorcond.measurement_type == 'pressure' %} selected{% endif %}>Pressure</option>
                          <option value="altitude"{% if each_sensorcond.measurement_type == 'altitude' %} selected{% endif %}>Altitude</option>
                        {%- endif -%}
                      </select>
                      is
                      <select class="form-control" id="Direction" name="Direction">
                        <option value=""></option>
                        <option value="above"{% if each_sensorcond.direction == 'above' %} selected{% endif %}>Above</option>
                        <option value="below"{% if each_sensorcond.direction == 'below' %} selected{% endif %}>Below</option>
                      </select>
                      the setpoint of 
                      {{formModSensorCond.Setpoint(class_='form-control', value=each_sensorcond.setpoint, **{'size':'3'})}}
                      (check every {{formModSensorCond.Period(class_='form-control', value=each_sensorcond.period, **{'size':'3'})}} seconds)
                    </td>
                  {% endif %}
                </tr>
                <tr>
                  <td>Then</td>
                  <td class="text-left">
                    <select class="form-control" id="modCondRelayID" name="modCondRelayID">
                      <option value=""></option>
                      {%- for each_relay in relay -%}
                        <option value="{{each_relay.id}}"{% if each_sensorcond.relay_id == each_relay.id %} selected{% endif %}>{{each_relay.id}} ({{each_relay.name}})</option>
                      {%- endfor -%}
                    </select>
                    <select class="form-control" id="RelayState" name="RelayState">
                      <option value=""></option>
                      <option value="on"{% if each_sensorcond.relay_state == 'on' %} selected{% endif %}>On</option>
                      <option value="off"{% if each_sensorcond.relay_state == 'off' %} selected{% endif %}>Off</option>
                    </select>
                    (for {{formModSensorCond.RelayDuration(class_='form-control', value=each_sensorcond.relay_on_duration, **{'size':'3'})}} sec.)
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td>
                    Execute {{formModSensorCond.DoExecute(class_='form-control', value=each_sensorcond.execute_command)}}, Notify
                    <select class="form-control" id="DoNotify" name="DoNotify">
                      <option value=""></option>
                      {%- for each_user in users -%}
                        <option value="{{each_user.user_email}}"{% if each_sensorcond.email_notify == each_user.user_email %} selected{% endif %}>{{each_user.user_email}}</option>
                      {%- endfor -%}
                    </select>, Flash LCD
                    <select class="form-control" id="DoFlashLCD" name="DoFlashLCD">
                      <option value=""></option>
                      {%- for each_lcd in lcd -%}
                        <option value="{{each_lcd.id}}"{% if each_sensorcond.flash_lcd == each_lcd.id %} selected{% endif %}>{{each_lcd.id}} ({{each_lcd.name}})</option>
                      {%- endfor -%}
                    </select>, Record
                    <select class="form-control" id="DoRecord" name="DoRecord">
                      <option value="">NOT YET WORKING</option>
                      <option value="photo"{% if each_sensorcond.relay_state == 'photo' %} selected{% endif %}>Photo Only</option>
                      <option value="photoemailf"{% if each_sensorcond.relay_state == 'photoemailf' %} selected{% endif %}>Email Photo</option>
                    </select>
                  </td>
                </tr>
              </table>
            </form>
          </div>

        {%- endfor -%}

      </div>

    {%- endfor -%}

    <div style="clear: both; padding:1em 0;"></div>

  {%- endfor -%}
  {%- endif -%}

  </div>

{% endblock -%}
